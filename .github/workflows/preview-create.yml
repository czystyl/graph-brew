name: Create Preview Environment

on:
  pull_request:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

permissions:
  pull-requests: write
  issues: write

jobs:
  generate-preview-url:
    name: Generate preview URL
    runs-on: ubuntu-latest
    steps:
      - name: Generate Branch Preview URL
        id: generate-preview-url
        run: |
          BRANCH_SHA=$(echo ${{ steps.extract_branch.outputs.branch }} | sha256sum | cut -c5-30)          
          echo "PREVIEW_SHA=$BRANCH_SHA" >> $GITHUB_ENV

  current-preview-url:
    name: Get current preview URL
    runs-on: ubuntu-latest
    steps:
      - name: Find preview deployment comment
        uses: peter-evans/find-comment@v2
        if: success() && github.event.number
        id: preview-comment
        with:
          issue-number: ${{ github.event.number }}
          body-includes: <!-- __PREVIEW_DEPLOYMENT__ -->

      - name: Get current preview url
        id: preview-url
        run: |
          REGEX="(__PREVIEW_URL: )(.*)( -->)"
          COMMENT_BODY="${{ steps.preview-comment.outputs.comment-body }}"

          if [[ "$COMMENT_BODY" =~ $REGEX ]]; then
              echo "PREVIEW_URL=${BASH_REMATCH[1]}" >> $GITHUB_ENV
          fi

      - name: Create or update preview environment comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.preview-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## üèóÔ∏è Building preview environment...
            <!-- __PREVIEW_DEPLOYMENT__ -->

  preview-database-uri:
    name: Get database connection strong
    runs-on: ubuntu-latest
    needs:
      - generate-preview-url
    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Vercel CLI
        run: pnpm add vercel@latest --global

      - name: Pull Vercel Preview  Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Replace Environment Variables
        run: |
          ENV_VARS=$(cat .vercel/.env.preview.local)
          DATABASE_URL_KEY=DATABASE_URL_$PREVIEW_SHA
          DB_REGEX="$DATABASE_URL_KEY=\"([^\"]*)\""

          if [[ $ENV_VARS =~ $DB_REGEX ]]; then
            echo "DATABASE_URL=${BASH_REMATCH[1]}" >> $GITHUB_ENV
            echo ${BASH_REMATCH[1]}            
          fi

  preview-database:
    runs-on: ubuntu-latest
    needs:
      - generate-preview-url
      - current-preview-url
      - preview-database-uri
    outputs:
      connection-string: ${{ steps.encoded-connection-string.outputs.uri }}
    env:
      BRANCH_NAME: $PREVIEW_SHA
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Check if Database exists
        id: check-database
        run: |
          FLY_APPS=$(flyctl apps list)          

          if [[ $FLY_APPS =~ $PREVIEW_SHA ]]; then
              echo "DATABASE_EXISTS=true" >> $GITHUB_ENV
          fi

      - name: Delete database if needed
        id: delete-database
        if: env.DATABASE_EXISTS && !env.DATABASE_URL
        run: |
          flyctl apps destroy $PREVIEW_SHA --yes
          echo "DATABASE_DELETED=true" >> $GITHUB_ENV

      - name: Create database
        id: create-database
        if: env.DATABASE_DELETED || !env.DATABASE_URL
        run: |
          PG_CREATE_COMMAND="
              flyctl postgres create \
              --name $BRANCH_NAME \
              --org product-brew \
              --region waw \
              --vm-size shared-cpu-1x - 256 \
              --initial-cluster-size 1 \
              --volume-size 1 \
              --image-ref flyio/postgres:14
            "

          PG_CREATE_OUTPUT=$($PG_CREATE_COMMAND)
          REGEX="(Connection string: )(.*)( Save)"

          if [[ $(echo $PG_CREATE_OUTPUT) =~ $REGEX ]]; then
            INTERNAL_CONNECTION_STRING=${BASH_REMATCH[2]}
          fi

          flyctl ips allocate-v4 --app $BRANCH_NAME

          sed "s/__APP_NAME_TEMPLATE__/$BRANCH_NAME/g" fly_postgres_template.toml > fly.toml

          flyctl deploy \
            --app $BRANCH_NAME \
            --image flyio/postgres:14 \
            --auto-confirm

          CONNECTION_STRING=$(echo $INTERNAL_CONNECTION_STRING | sed "s/.internal:/.fly.dev:/g")
          echo "DATABASE_URL=$CONNECTION_STRING" >> $GITHUB_ENV

  deploy-preview:
    name: Deploy preview environment
    runs-on: ubuntu-latest
    needs:
      - generate-preview-url
      - preview-database
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Vercel CLI
        run: pnpm add vercel@latest --global

      - name: Pull Vercel Preview  Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Replace Environment Variables
        run: |
          vars=$(cat .vercel/.env.preview.local)

          DB_REGEX='DATABASE_URL="(.*)"[[:space:]]'

          echo $DATABASE_URL

          if [[ $vars =~ $DB_REGEX ]]; then
            echo ${BASH_REMATCH[1]}
            
          else
            echo "No match"
          fi

          echo ${{ needs.preview-database.outputs.connection-string }} | vercel env add DATABASE_URL_$PREVIEW_SHA preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build Project Artifacts
        run: |
          cat .vercel/.env.preview.local
          vercel build --token=${{ secrets.VERCEL_TOKEN }}
          pnpx prisma generate

      - name: Run Migrations
        run: |
          echo $DATABASE_URL

          pnpx prisma migrate deploy

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          DOMAIN=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DOMAIN}" >> $GITHUB_OUTPUT

  alias-preview:
    name: Add environment URL alias
    runs-on: ubuntu-latest
    needs:
      - deploy-preview
      - generate-preview-url
    steps:
      - name: Alias current deployment
        run: |
          vercel alias \
            ${{ needs.deploy-preview.outputs.url }} \
            $PREVIEW_SHA.vercel.app \
            --token=${{ secrets.VERCEL_TOKEN }}

  remove-old-preview:
    name: Remove old environment
    runs-on: ubuntu-latest
    needs:
      - alias-preview
    steps:
      - current-preview-url
      - name: Remove previous preview environment
        run: |
          if [ $PREVIEW_URL ]; then
              vercel remove $PREVIEW_URL --yes --token=${{ secrets.VERCEL_TOKEN }}          
          fi

  update-deployment-comment:
    name: Update preview state
    runs-on: ubuntu-latest
    needs:
      - alias-preview
      - generate-preview-url
      - preview-database
      - deploy-preview
    steps:
      - name: Find preview environment comment to update
        uses: peter-evans/find-comment@v2
        if: success() && github.event.number
        id: preview-comment
        with:
          issue-number: ${{ github.event.number }}
          body-includes: <!-- __PREVIEW_DEPLOYMENT__ -->

      - name: Create or update preview link comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.preview-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## [üöÄ Your preview environment is ready!](https://$PREVIEW_SHA.vercel.app)

            <!-- __PREVIEW_DEPLOYMENT__ -->
            <!-- __PREVIEW_URL: ${{ needs.deploy-preview.outputs.url }} -->
            <!-- __DATABASE_CONNECTION_STRING: ${{ needs.preview-database.outputs.connection-string }} -->
