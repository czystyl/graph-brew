name: Create Preview Environment

on:
  pull_request:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

permissions:
  pull-requests: write
  issues: write

jobs:
  generate-preview-hash:
    name: Generate preview URL
    runs-on: ubuntu-latest
    outputs:
      preview-sha: ${{ steps.generate-preview-hash.outputs.preview-sha }}
    steps:
      - name: Generate Branch Preview URL
        id: generate-preview-hash
        run: |
          BRANCH_SHA=$(echo ${{ steps.extract_branch.outputs.branch }} | sha256sum | cut -c5-30)          
          echo "preview-sha=$BRANCH_SHA" >> $GITHUB_OUTPUT

  current-preview-url:
    name: Get current preview URL
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.preview-url.outputs.url }}
    steps:
      - name: Find preview deployment comment
        uses: peter-evans/find-comment@v2
        if: success() && github.event.number
        id: preview-comment
        with:
          issue-number: ${{ github.event.number }}
          body-includes: <!-- __PREVIEW_DEPLOYMENT__ -->

      - name: Get current preview url
        id: preview-url
        run: |
          REGEX="(__PREVIEW_URL: )(.*)( -->)"
          COMMENT_BODY="${{ steps.preview-comment.outputs.comment-body }}"

          if [[ "$COMMENT_BODY" =~ $REGEX ]]; then
              echo "url=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          fi

      - name: Create or update preview environment comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.preview-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## 🏗️ Building preview environment...
            <!-- __PREVIEW_DEPLOYMENT__ -->

  preview-database-uri:
    name: Get database connection strong
    runs-on: ubuntu-latest
    needs:
      - generate-preview-hash
    outputs:
      uri: ${{ steps.connection-string.outputs.uri }}
    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Vercel CLI
        run: pnpm add vercel@latest --global

      - name: Pull Vercel Preview  Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Get the connection string
        id: connection-string
        run: |
          ENV_VARS=$(cat .vercel/.env.preview.local)
          DATABASE_URL_KEY=DATABASE_URL_${{ needs.generate-preview-hash.outputs.preview-sha }}
          DB_REGEX="$DATABASE_URL_KEY=\"([^\"]*)\""

          if [[ $ENV_VARS =~ $DB_REGEX ]]; then
            echo "uri=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            
            
            echo ${BASH_REMATCH[1]}            
          fi

  preview-database:
    runs-on: ubuntu-latest
    needs:
      - generate-preview-hash
      - current-preview-url
      - preview-database-uri
    outputs:
      DATABASE_URL: ${{ steps.create-database.output.DATABASE_URL }}
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Check if Database exists
        id: check-database
        run: |
          FLY_APPS=$(flyctl apps list)          

          if [[ $FLY_APPS =~ ${{ needs.generate-preview-hash.outputs.preview-sha }} ]]; then
              echo exists!
              echo "DATABASE_EXISTS=true" >> $GITHUB_OUTPUT         
          fi

      - name: Delete database if needed
        id: delete-database
        if: steps.check-database.outputs.DATABASE_EXISTS && !needs.preview-database-uri.outputs.uri
        run: |
          flyctl apps destroy ${{ needs.generate-preview-hash.outputs.preview-sha }} --yes
          echo "DATABASE_DELETED=true" >> $GITHUB_OUTPUT

      - name: Create database
        id: create-database
        if: steps.delete-database.outputs.DATABASE_DELETED || !needs.preview-database-uri.outputs.uri
        run: |
          PG_CREATE_COMMAND="
              flyctl postgres create \
              --name $BRANCH_NAME \
              --org product-brew \
              --region waw \
              --vm-size shared-cpu-1x - 256 \
              --initial-cluster-size 1 \
              --volume-size 1 \
              --image-ref flyio/postgres:14
            "

          PG_CREATE_OUTPUT=$($PG_CREATE_COMMAND)
          REGEX="(Connection string: )(.*)( Save)"

          if [[ $(echo $PG_CREATE_OUTPUT) =~ $REGEX ]]; then
            INTERNAL_CONNECTION_STRING=${BASH_REMATCH[2]}
          fi

          flyctl ips allocate-v4 --app $BRANCH_NAME

          sed "s/__APP_NAME_TEMPLATE__/$BRANCH_NAME/g" fly_postgres_template.toml > fly.toml

          flyctl deploy \
            --app $BRANCH_NAME \
            --image flyio/postgres:14 \
            --auto-confirm

          CONNECTION_STRING=$(echo $INTERNAL_CONNECTION_STRING | sed "s/.internal:/.fly.dev:/g")
          echo "DATABASE_URL=$CONNECTION_STRING" >> $GITHUB_OUTPUT

  deploy-preview:
    name: Deploy preview environment
    runs-on: ubuntu-latest
    needs:
      - generate-preview-hash
      - preview-database
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Vercel CLI
        run: pnpm add vercel@latest --global

      - name: Pull Vercel Preview  Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Replace Environment Variables
        run: |
          PREVIEW_SHA=${{ needs.generate-preview-hash.outputs.preview-sha }}

          ENV_VARIABLES=$(cat .vercel/.env.preview.local)
          SUB="$DATABASE_URL_KEY=\"$DATABASE_URL\""

          if [[ "$ENV_VARIABLES" == *"$SUB"* ]]; then
            vercel env rm DATABASE_URL_$PREVIEW_SHA --yes
            echo $DATABASE_URL | vercel env add DATABASE_URL_$PREVIEW_SHA preview --token=${{ secrets.VERCEL_TOKEN }}
          fi

      - name: Build Project Artifacts
        run: |
          cat .vercel/.env.preview.local
          vercel build --token=${{ secrets.VERCEL_TOKEN }}
          pnpx prisma generate

      - name: Run Migrations
        run: pnpx prisma migrate deploy

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          DOMAIN=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=${DOMAIN}" >> $GITHUB_OUTPUT

  alias-preview:
    name: Add environment URL alias
    runs-on: ubuntu-latest
    needs:
      - deploy-preview
      - generate-preview-hash
    steps:
      - name: Alias current deployment
        run: |
          vercel alias \
            ${{ needs.deploy-preview.outputs.url }} \
            ${{ needs.generate-preview-hash.outputs.preview-sha }}.vercel.app \
            --token=${{ secrets.VERCEL_TOKEN }}

  remove-old-preview:
    name: Remove old environment
    runs-on: ubuntu-latest
    needs:
      - alias-preview
    steps:
      - name: Remove previous preview environment
        run: |
          if [ $PREVIEW_URL ]; then
              vercel remove $PREVIEW_URL --yes --token=${{ secrets.VERCEL_TOKEN }}          
          fi

  update-deployment-comment:
    name: Update preview state
    runs-on: ubuntu-latest
    needs:
      - alias-preview
      - generate-preview-hash
      - preview-database
      - deploy-preview
    steps:
      - name: Find preview environment comment to update
        uses: peter-evans/find-comment@v2
        if: success() && github.event.number
        id: preview-comment
        with:
          issue-number: ${{ github.event.number }}
          body-includes: <!-- __PREVIEW_DEPLOYMENT__ -->

      - name: Create or update preview link comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.preview-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## [🚀 Your preview environment is ready!](https://${{ needs.generate-preview-hash.outputs.preview-sha }}.vercel.app)

            <!-- __PREVIEW_DEPLOYMENT__ -->
            <!-- __PREVIEW_URL: ${{ needs.deploy-preview.outputs.url }} -->
            <!-- __DATABASE_CONNECTION_STRING: ${{ needs.preview-database.outputs.connection-string }} -->
