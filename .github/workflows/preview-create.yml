name: Create Preview Environment

on:
  pull_request:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

permissions:
  pull-requests: write
  issues: write

jobs:
  generate-preview-hash:
    name: Generate preview URL
    runs-on: ubuntu-latest
    outputs:
      PREVIEW_SHA: ${{ steps.generate-preview-hash.outputs.PREVIEW_SHA }}
    steps:
      - name: Generate Branch Preview URL
        id: generate-preview-hash
        run: |

          BRANCH_SHA=$(echo ${{ github.head_ref }}| sha256sum | cut -c5-30)
          echo "PREVIEW_SHA=$BRANCH_SHA" >> $GITHUB_OUTPUT

  current-preview-url:
    name: Check current preview URL
    runs-on: ubuntu-latest
    outputs:
      URL: ${{ steps.preview-url.outputs.URL }}
    steps:
      - name: Find preview deployment comment
        uses: peter-evans/find-comment@v2
        if: success() && github.event.number
        id: preview-comment
        with:
          issue-number: ${{ github.event.number }}
          body-includes: <!-- __PREVIEW_DEPLOYMENT__ -->

      - name: Get current preview url
        id: preview-url
        run: |
          REGEX="__PREVIEW_URL: (.*) -->"
          COMMENT_BODY="${{ steps.preview-comment.outputs.comment-body }}"

          echo "$COMMENT_BODY"

          if [[ "$COMMENT_BODY" =~ $REGEX ]]; then
              echo "URL=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          fi

      - name: Create or update preview environment comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.preview-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## üèóÔ∏è Building preview environment...
            <!-- __PREVIEW_DEPLOYMENT__ -->
            <!-- __PREVIEW_URL: ${{ steps.preview-url.outputs.url }} -->

  preview-database-url:
    name: Get database connection strong
    runs-on: ubuntu-latest
    needs:
      - generate-preview-hash
    outputs:
      URL: ${{ steps.connection-string.outputs.URL }}
    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Vercel CLI
        run: pnpm add vercel@latest --global

      - name: Pull Vercel Preview  Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Get the connection string
        id: connection-string
        run: |
          ENV_VARS=$(cat .vercel/.env.preview.local)

          DATABASE_URL_KEY=DATABASE_URL_${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }}
          DB_REGEX="$DATABASE_URL_KEY=\"([^\"]*)\""

          if [[ $ENV_VARS =~ $DB_REGEX ]]; then
            EXISTING_URL=$(echo -n ${BASH_REMATCH[1]} | base64 | tr '\n' ' ' | sed "s/ //g")

            echo "URL=$EXISTING_URL" >> $GITHUB_OUTPUT
          fi

  preview-database:
    name: Preview database
    runs-on: ubuntu-latest
    needs:
      - generate-preview-hash
      - preview-database-url
    outputs:
      URL: ${{ steps.create-database.outputs.URL }}
    env:
      BRANCH_NAME: ${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }}
    steps:
      - uses: actions/checkout@v3
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Check if Database exists
        id: check-database
        run: |
          FLY_APPS=$(flyctl apps list)

          if [[ $FLY_APPS =~ ${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }} ]]; then
              echo "DATABASE_EXISTS=true" >> $GITHUB_OUTPUT
          fi

      - name: Delete database if needed
        id: delete-database
        if: steps.check-database.outputs.DATABASE_EXISTS && !needs.preview-database-url.outputs.URl
        run: |
          flyctl apps destroy ${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }} --yes

          echo "DATABASE_DELETED=true" >> $GITHUB_OUTPUT

      - name: Create database
        id: create-database
        if: steps.delete-database.outputs.DATABASE_DELETED || !needs.preview-database-url.outputs.URl || !steps.check-database.outputs.DATABASE_EXISTS
        run: |
          PG_CREATE_COMMAND="
              flyctl postgres create \
              --name $BRANCH_NAME \
              --org product-brew \
              --region waw \
              --vm-size shared-cpu-1x - 256 \
              --initial-cluster-size 1 \
              --volume-size 1 \
              --image-ref flyio/postgres:14
            "

          PG_CREATE_OUTPUT=$($PG_CREATE_COMMAND | tr '\n' ' ' | sed "s/ //g")
          REGEX="Connectionstring:(.*)Save"

          if [[ $PG_CREATE_OUTPUT =~ $REGEX ]]; then
            INTERNAL_CONNECTION_STRING=${BASH_REMATCH[1]}
          else
            echo Ops && exit 1
          fi

          CONNECTION_STRING=$(echo -n $INTERNAL_CONNECTION_STRING | sed "s/.internal:/.fly.dev:/g" | base64 | tr '\n' ' ' | sed "s/ //g")

          echo "URL=$CONNECTION_STRING" >> $GITHUB_OUTPUT

      - name: Assign static IP
        if: steps.create-database.outputs.URL
        run: flyctl ips allocate-v4 --app $BRANCH_NAME

      - name: Deploy Database update
        if: steps.create-database.outputs.URL
        run: |
          sed "s/__APP_NAME_TEMPLATE__/$BRANCH_NAME/g" fly_postgres_template.toml > fly.toml

          flyctl deploy \
            --app $BRANCH_NAME \
            --image flyio/postgres:14 \
            --auto-confirm

  deploy-preview:
    name: Deploy preview environment
    runs-on: ubuntu-latest
    needs:
      - generate-preview-hash
      - preview-database
      - preview-database-url
    outputs:
      URL: ${{ steps.deploy.outputs.URL }}
    env:
      DATABASE_URL_KEY: "DATABASE_URL_${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }}"
    steps:
      - uses: actions/checkout@v3

      - uses: pnpm/action-setup@v2
        name: Install pnpm
        id: pnpm-install
        with:
          version: 7
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        name: Setup pnpm cache
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Vercel CLI
        run: pnpm add vercel@latest --global

      - name: Pull Vercel Preview  Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Update DATABASE_URL environment variable
        run: |
          NEW_DATABASE_URL=$(echo "${{ needs.preview-database.outputs.URL }}" | base64 -d)
          EXISTING_DATABASE_URL=$(echo "${{ needs.preview-database-url.outputs.URL }}" | base64 -d)

          if [[ $NEW_DATABASE_URL ]]; then
            vercel env rm $DATABASE_URL_KEY --yes --token=${{ secrets.VERCEL_TOKEN }} || true
            echo -n $NEW_DATABASE_URL | vercel env add $DATABASE_URL_KEY preview --token=${{ secrets.VERCEL_TOKEN }}

            echo "$DATABASE_URL_KEY=$NEW_DATABASE_URL" >> $GITHUB_ENV
          elif [[ $EXISTING_DATABASE_URL ]]; then
            echo "$DATABASE_URL_KEY=$EXISTING_DATABASE_URL" >> $GITHUB_ENV
          else
            echo "Ops, something went wrong!" && exit 1
          fi

      - name: Update database env
        run: |
          sed -i "s/env(\"DATABASE_URL\")/env(\"$DATABASE_URL_KEY\")/g" prisma/schema.prisma
          source .vercel/.env.preview.local

      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Generate Prisma client
        run: pnpx prisma generate

      - name: Run migrations
        run: pnpx prisma migrate deploy

      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          DOMAIN=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "URL=${DOMAIN}" >> $GITHUB_OUTPUT

  alias-preview:
    name: Assign preview domain
    runs-on: ubuntu-latest
    needs:
      - deploy-preview
      - generate-preview-hash
    steps:
      - name: Alias current deployment
        run: |
          vercel alias \
            ${{ needs.deploy-preview.outputs.URL }} \
            ${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }}.vercel.app \
            --token=${{ secrets.VERCEL_TOKEN }}

  destroy-previous-preview:
    name: Destroy previous preview
    runs-on: ubuntu-latest
    needs:
      - alias-preview
      - current-preview-url
    steps:
      - name: Remove previous preview environment
        run: |
          PREVIEW_URL="${{ needs.current-preview-url.outputs.URL }}"

          if [ $PREVIEW_URL ]; then
              vercel remove $PREVIEW_URL --yes --token=${{ secrets.VERCEL_TOKEN }}
          fi

  update-deployment-comment:
    name: Update PR comment
    runs-on: ubuntu-latest
    needs:
      - alias-preview
      - generate-preview-hash
      - deploy-preview
    steps:
      - name: Find preview environment comment to update
        uses: peter-evans/find-comment@v2
        if: success() && github.event.number
        id: preview-comment
        with:
          issue-number: ${{ github.event.number }}
          body-includes: <!-- __PREVIEW_DEPLOYMENT__ -->

      - name: Create or update preview link comment
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.preview-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            ## [üöÄ Your preview environment is ready!](https://${{ needs.generate-preview-hash.outputs.PREVIEW_SHA }}.vercel.app)

            <!-- __PREVIEW_DEPLOYMENT__ -->
            <!-- __PREVIEW_URL: ${{ needs.deploy-preview.outputs.url }} -->
